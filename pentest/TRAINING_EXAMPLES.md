# Ejemplos de Entrenamiento Optimizado con Mejores Datos

Este documento proporciona ejemplos prácticos de cómo entrenar los modelos ML con los mejores datos posibles.

## 1. Evaluación de Calidad de Datos

Antes de entrenar, siempre evalúa la calidad de tus datos:

```bash
# Evaluar calidad de datos
curl -X POST "http://localhost:8000/ml/data-quality" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer admin-key" \
  -d '{
    "scan_results": [
      {
        "target": "example.com",
        "vulnerabilities": [
          {
            "type": "SQL Injection",
            "severity": "high",
            "confidence": 0.9,
            "location": "/login.php"
          }
        ],
        "timestamp": "2024-01-15T10:30:00Z",
        "source_ip": "192.168.1.100"
      }
    ],
    "target_domains": ["example.com"]
  }'
```

## 2. Entrenamiento Básico

Para entrenamiento estándar:

```bash
curl -X POST "http://localhost:8000/ml/train" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer admin-key" \
  -d '{
    "scan_results": [...],
    "target_domains": [...]
  }'
```

## 3. Entrenamiento Optimizado

Para entrenamiento con técnicas avanzadas:

```bash
curl -X POST "http://localhost:8000/ml/train/optimized" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer admin-key" \
  -d '{
    "scan_results": [...],
    "target_domains": [...],
    "augmentation_factor": 3.0,
    "cv_folds": 10,
    "optimize_hyperparams": true,
    "feature_selection": true,
    "ensemble_methods": true,
    "balance_classes": true,
    "temporal_validation": true,
    "min_samples_required": 100
  }'
```

## 4. Mejores Prácticas para Datos de Calidad

### 4.1 Diversidad de Datos

```json
{
  "scan_results": [
    {
      "target": "ecommerce-site.com",
      "vulnerabilities": [
        {"type": "XSS", "severity": "medium", "confidence": 0.8}
      ],
      "timestamp": "2024-01-01T09:00:00Z",
      "source_ip": "10.0.1.50"
    },
    {
      "target": "banking-app.com",
      "vulnerabilities": [
        {"type": "CSRF", "severity": "high", "confidence": 0.95}
      ],
      "timestamp": "2024-01-02T14:30:00Z",
      "source_ip": "172.16.0.100"
    },
    {
      "target": "news-portal.org",
      "vulnerabilities": [],
      "timestamp": "2024-01-03T11:15:00Z",
      "source_ip": "192.168.100.25"
    }
  ]
}
```

### 4.2 Balance de Clases

Asegúrate de incluir tanto sitios maliciosos como benignos:

- **50% eventos maliciosos**: Sitios con vulnerabilidades reales
- **50% eventos benignos**: Sitios seguros sin vulnerabilidades

### 4.3 Cobertura Temporal

Incluye datos de diferentes períodos:

```json
{
  "scan_results": [
    {"timestamp": "2024-01-01T00:00:00Z"},
    {"timestamp": "2024-01-08T00:00:00Z"},
    {"timestamp": "2024-01-15T00:00:00Z"},
    {"timestamp": "2024-01-22T00:00:00Z"}
  ]
}
```

### 4.4 Completitud de Campos

Asegúrate de que todos los campos requeridos estén presentes:

```json
{
  "target": "example.com",
  "vulnerabilities": [...],
  "timestamp": "2024-01-15T10:30:00Z",
  "source_ip": "192.168.1.100",
  "scan_duration": 45.2,
  "tools_used": ["nmap", "nikto", "sqlmap"],
  "response_codes": [200, 404, 500],
  "technologies": ["Apache", "PHP", "MySQL"]
}
```

## 5. Monitoreo del Entrenamiento

### 5.1 Verificar Estado

```bash
curl -X GET "http://localhost:8000/ml/training/{training_id}/status" \
  -H "Authorization: Bearer admin-key"
```

### 5.2 Respuesta de Estado

```json
{
  "status": "completed",
  "training_id": "abc12345",
  "results": {
    "metrics": {
      "RandomForest": {
        "accuracy": 0.95,
        "f1_score": 0.93,
        "precision": 0.94,
        "recall": 0.92
      }
    },
    "data_quality": {
      "overall_score": 0.87,
      "completeness": 0.95,
      "consistency": 0.89,
      "balance": 0.78
    }
  }
}
```

## 6. Optimización Continua

### 6.1 Análisis de Resultados

1. **Revisar métricas de calidad de datos**
2. **Analizar rendimiento del modelo**
3. **Identificar áreas de mejora**
4. **Recopilar más datos si es necesario**

### 6.2 Iteración del Proceso

```bash
# 1. Evaluar datos actuales
curl -X POST "http://localhost:8000/ml/data-quality" ...

# 2. Si la calidad es baja, mejorar datos
# 3. Entrenar con configuración optimizada
curl -X POST "http://localhost:8000/ml/train/optimized" ...

# 4. Monitorear resultados
curl -X GET "http://localhost:8000/ml/training/{id}/status" ...

# 5. Repetir si es necesario
```

## 7. Configuraciones Recomendadas

### 7.1 Para Datasets Pequeños (< 100 muestras)

```json
{
  "augmentation_factor": 5.0,
  "cv_folds": 5,
  "optimize_hyperparams": false,
  "balance_classes": true
}
```

### 7.2 Para Datasets Medianos (100-1000 muestras)

```json
{
  "augmentation_factor": 3.0,
  "cv_folds": 10,
  "optimize_hyperparams": true,
  "ensemble_methods": true
}
```

### 7.3 Para Datasets Grandes (> 1000 muestras)

```json
{
  "augmentation_factor": 2.0,
  "cv_folds": 10,
  "optimize_hyperparams": true,
  "ensemble_methods": true,
  "temporal_validation": true
}
```

## 8. Solución de Problemas

### 8.1 Baja Calidad de Datos

**Problema**: `overall_score < 0.6`

**Soluciones**:
- Añadir más diversidad de dominios
- Balancear clases maliciosas/benignas
- Completar campos faltantes
- Extender cobertura temporal

### 8.2 Bajo Rendimiento del Modelo

**Problema**: `f1_score < 0.8`

**Soluciones**:
- Aumentar `augmentation_factor`
- Habilitar `optimize_hyperparams`
- Usar `ensemble_methods`
- Recopilar más datos de entrenamiento

### 8.3 Entrenamiento Lento

**Problema**: Tiempo de entrenamiento > 30 minutos

**Soluciones**:
- Reducir `cv_folds`
- Deshabilitar `optimize_hyperparams`
- Reducir `augmentation_factor`
- Usar menos algoritmos en ensemble

## 9. Ejemplo Completo

```python
import requests
import json
from datetime import datetime, timedelta

# Configuración
API_BASE = "http://localhost:8000/ml"
HEADERS = {
    "Content-Type": "application/json",
    "Authorization": "Bearer admin-key"
}

# Datos de ejemplo de alta calidad
training_data = {
    "scan_results": [
        # Sitios maliciosos
        {
            "target": "malicious-site1.com",
            "vulnerabilities": [
                {"type": "SQL Injection", "severity": "high", "confidence": 0.95},
                {"type": "XSS", "severity": "medium", "confidence": 0.8}
            ],
            "timestamp": "2024-01-01T10:00:00Z",
            "source_ip": "192.168.1.100"
        },
        # Sitios benignos
        {
            "target": "secure-site1.com",
            "vulnerabilities": [],
            "timestamp": "2024-01-02T11:00:00Z",
            "source_ip": "192.168.1.101"
        }
        # ... más datos balanceados
    ],
    "target_domains": ["malicious-site1.com", "secure-site1.com"],
    "augmentation_factor": 3.0,
    "cv_folds": 10,
    "optimize_hyperparams": True,
    "feature_selection": True,
    "ensemble_methods": True,
    "balance_classes": True,
    "temporal_validation": True,
    "min_samples_required": 50
}

# 1. Evaluar calidad de datos
quality_response = requests.post(
    f"{API_BASE}/data-quality",
    headers=HEADERS,
    json={
        "scan_results": training_data["scan_results"],
        "target_domains": training_data["target_domains"]
    }
)

print("Calidad de datos:", quality_response.json())

# 2. Si la calidad es buena, proceder con entrenamiento
if quality_response.json()["overall_score"] > 0.7:
    train_response = requests.post(
        f"{API_BASE}/train/optimized",
        headers=HEADERS,
        json=training_data
    )
    
    training_id = train_response.json()["training_id"]
    print(f"Entrenamiento iniciado: {training_id}")
    
    # 3. Monitorear progreso
    import time
    while True:
        status_response = requests.get(
            f"{API_BASE}/training/{training_id}/status",
            headers=HEADERS
        )
        
        status = status_response.json()["status"]
        print(f"Estado: {status}")
        
        if status in ["completed", "failed"]:
            print("Resultados:", status_response.json())
            break
        
        time.sleep(30)  # Esperar 30 segundos
else:
    print("Calidad de datos insuficiente. Mejorar datos antes de entrenar.")
```

Este ejemplo muestra el flujo completo para entrenar modelos ML con los mejores datos posibles.