import requests
import json
import logging
from datetime import datetime
from pathlib import Path
import requests

log = logging.getLogger("pentest")

CISA_KEV_URL = "https://www.cisa.gov/sites/default/files/feeds/known_exploited_vulnerabilities.json"

def download_cisa_kev_list():
    """Descarga la lista de CISA KEV."""
    try:
        response = requests.get(CISA_KEV_URL)
        response.raise_for_status()  # Raise an HTTPError for bad responses (4xx or 5xx)
        return response.json()
    except requests.exceptions.RequestException as e:
        log.error(f"Error al descargar la lista de CISA KEV: {e}")
        return None

def filter_cisa_kev_by_tech(cisa_kev_list: dict, tech_stack: list) -> list:
    """Filtra la lista de CISA KEV por tecnologÃ­a detectada."""
    if not cisa_kev_list or not tech_stack:
        return []

    filtered_vulnerabilities = []
    for vulnerability in cisa_kev_list.get("vulnerabilities", []):
        vendor_product = vulnerability.get("vendorProduct", "").lower()
        for tech in tech_stack:
            if tech.lower() in vendor_product:
                filtered_vulnerabilities.append(vulnerability)
                break
    return filtered_vulnerabilities

def cisa_kev_monitor(domain: str, tmp_dir: Path, tech_stack: list) -> list:
    """Monitoriza CISA KEV y alerta sobre vulnerabilidades relevantes."""
    log.info("Iniciando monitorizaciÃ³n de CISA KEV...")
    kev_list = download_cisa_kev_list()
    if kev_list:
        relevant_vulnerabilities = filter_cisa_kev_by_tech(kev_list, tech_stack)
        if relevant_vulnerabilities:
            log.warning("ðŸš¨ Â¡Alerta! Se encontraron vulnerabilidades de CISA KEV relevantes para la tecnologÃ­a detectada:")
            cisa_kev_file = tmp_dir / f"{domain}_cisa_kev.json"
            try:
                with open(cisa_kev_file, 'w') as f:
                    json.dump(relevant_vulnerabilities, f, indent=4)
                log.info(f"Resultados de CISA KEV guardados en {cisa_kev_file}")
            except IOError as e:
                log.error(f"Error al guardar los resultados de CISA KEV en {cisa_kev_file}: {e}")

            for vul in relevant_vulnerabilities:
                log.warning(f"  - CVE ID: {vul.get('cveID')}, Vendor/Product: {vul.get('vendorProduct')}, Due Date: {vul.get('dueDate')}")
            return relevant_vulnerabilities
        else:
            log.info("No se encontraron vulnerabilidades de CISA KEV relevantes para la tecnologÃ­a detectada.")
    return []