import logging
import subprocess
from pathlib import Path
from typing import List, Dict, Any

from pentest.exceptions import ScreenshotError

log = logging.getLogger("pentest")

def take_screenshots(httpx_file: Path, output_dir: Path) -> Path:
    """
    Toma capturas de pantalla de los hosts activos usando gowitness.
    Los resultados se guardan en un archivo JSON.
    """


    if httpx_file is None or not httpx_file.exists():
        log.warning(f"No se encontró el archivo httpx_file para capturas de pantalla o es None: {httpx_file}. Devolviendo resultados vacíos.")
        # Create an empty JSON file to return
        with open(output_json_file, "w") as f:
            f.write("[]")
        return output_json_file

    log.info("Iniciando captura de pantallas con gowitness...")
    
    output_json_file = output_dir / "gowitness_results.json"
    
    try:
        command = [
            "/root/go/bin/gowitness",
            "file",
            "-f", str(httpx_file),
            "-o", str(output_dir),
            "--json", str(output_json_file),
            "--disable-logging",
            "--no-http-redirects",
            "--no-https-redirects",
            "--disable-db"
        ]
        
        log.debug(f"Ejecutando comando: {' '.join(command)}")
        
        result = subprocess.run(command, capture_output=True, text=True, check=True)
        
        log.info("Captura de pantallas con gowitness completada.")
        log.debug(f"Salida de gowitness: {result.stdout}")
        
        if result.stderr:
            log.warning(f"Errores/Advertencias de gowitness: {result.stderr}")
            
        if not output_json_file.exists():
            raise ScreenshotError(f"El archivo de resultados JSON de gowitness no fue creado: {output_json_file}")
            
        return output_json_file
        
    except subprocess.CalledProcessError as e:
        log.error(f"Error al ejecutar gowitness: {e.stderr}")
        raise ScreenshotError(f"Error al ejecutar gowitness: {e.stderr}") from e
    except FileNotFoundError:
        log.error("gowitness no encontrado. Asegúrate de que esté instalado y en tu PATH.")
        raise ScreenshotError("gowitness no encontrado. Asegúrate de que esté instalado y en tu PATH.")
    except Exception as e:
        log.error(f"Error inesperado durante la captura de pantallas: {e}")
        raise ScreenshotError(f"Error inesperado durante la captura de pantallas: {e}") from e